- name: Prepare Production Server and Deploy App
  hosts: localhost
  become: yes

  vars:
    sys_user: "ubuntu"

  tasks:

    - name: Install dependencies
      apt:
        name: [ca-certificates, curl, gnupg, lsb-release]
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name: [docker-ce, docker-ce-cli, containerd.io]
        state: present
        update_cache: yes

    - name: Add user to Docker group
      user:
        name: "{{ sys_user }}"
        groups: docker
        append: yes

    - name: Install kubectl
      snap:
        name: kubectl
        classic: yes

    - name: Download Minikube
      get_url:
        url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        dest: /usr/local/bin/minikube
        mode: '0755'

    - name: Check Minikube status
      command: minikube status
      register: minikube_status
      ignore_errors: yes
      become: no

    - name: Start Minikube
      shell: minikube start --driver=docker
      become: no
      when: "'Running' not in minikube_status.stdout"

    - name: Apply Kubernetes Deployment
      shell: minikube kubectl -- apply -f /home/ubuntu/weather-ml-app_forked/k8s/deployment.yaml
      become: no

    - name: Apply Kubernetes Service
      shell: minikube kubectl -- apply -f /home/ubuntu/weather-ml-app_forked/k8s/service.yaml
      become: no


    - name: Scale Deployment to 3 Replicas
      shell: minikube kubectl -- scale deployment/weather-deployment --replicas=3
      become: no
