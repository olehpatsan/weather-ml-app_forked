- name: Prepare Production Server and Deploy App
  hosts: localhost
  become: yes

  vars:
    sys_user: "ubuntu"
    dockerhub_user: "DOCKERHUB_USERNAME"

  tasks:

    - name: Install dependencies
      apt:
        name: [ca-certificates, curl, gnupg, lsb-release]
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name: [docker-ce, docker-ce-cli, containerd.io]
        state: present
        update_cache: yes

    - name: Add user to Docker group
      user:
        name: "{{ sys_user }}"
        groups: docker
        append: yes

    - name: Install kubectl
      snap:
        name: kubectl
        classic: yes

    - name: Download Minikube
      get_url:
        url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        dest: /usr/local/bin/minikube
        mode: '0755'

    - name: Check Minikube status
      command: minikube status
      register: minikube_status
      ignore_errors: yes
      become: no

    - name: Start Minikube
      shell: minikube start --driver=docker
      become: no
      when: "'Running' not in minikube_status.stdout"

    - name: Create DockerHub registry secret
      shell: >
        minikube kubectl -- create secret docker-registry regcred
        --docker-username={{ dockerhub_user }}
        --docker-password="{{ lookup('env','DOCKERHUB_TOKEN') }}"
        --docker-email="devops@example.com"
        --dry-run=client -o yaml | minikube kubectl -- apply -f -
      become: no

    - name: Create Deployment manifest
      copy:
        dest: "/home/{{ sys_user }}/deployment.yml"
        content: |
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: weather-deployment
            labels:
              app: weather
          spec:
            replicas: 2
            revisionHistoryLimit: 2
            strategy:
              type: RollingUpdate
              rollingUpdate:
                maxSurge: 1
                maxUnavailable: 0
            selector:
              matchLabels:
                app: weather
            template:
              metadata:
                labels:
                  app: weather
              spec:
                containers:
                  - name: weather
                    image: "{{ dockerhub_user }}/weather-ml-app:latest"
                    imagePullPolicy: Always
                    ports:
                      - containerPort: 5000
                imagePullSecrets:
                  - name: regcred

    - name: Apply Deployment
      shell: minikube kubectl -- apply -f /home/{{ sys_user }}/deployment.yml
      become: no

    - name: Create Service manifest
      copy:
        dest: "/home/{{ sys_user }}/service.yml"
        content: |
          apiVersion: v1
          kind: Service
          metadata:
            name: weather-service
          spec:
            type: NodePort
            selector:
              app: weather
            ports:
              - protocol: TCP
                port: 5000
                targetPort: 5000
                nodePort: 30005

    - name: Apply Service
      shell: minikube kubectl -- apply -f /home/{{ sys_user }}/service.yml
      become: no

    - name: Scale Deployment
      shell: minikube kubectl -- scale deployment/weather-deployment --replicas=3
      become: no
